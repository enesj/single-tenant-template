<!-- ai: {:tags [:migrations :overview] :kind :overview} -->

# Database Migrations (Single-Tenant)

This folder documents the migration system for the **single-tenant template**.

## ğŸ“š Documentation Structure

### Core Documentation
- **[Migration Overview](./migration-overview.md)** - System architecture and workflows
- **[Complete Guide](./complete-guide.md)** - Detailed workflows, formats, and operations

## ğŸš€ Quick Navigation

**Need to...**
- **Understand the system?** â†’ [Migration Overview](./migration-overview.md)
- **See full workflows?** â†’ [Complete Guide](./complete-guide.md)

## ğŸ”§ System Overview

This project uses the **automigrate** library with a single-tenant default.

- **ğŸ“¦ Models-driven**: Database schema defined in `resources/db/models.edn` (consolidated from `resources/db/{template,shared,domain}`)
- **ğŸ¢ Single-tenant by default**
- **ğŸ”„ Auto-generation**: Migrations automatically generated from model changes and extended EDN (functions, triggers, policies, views)
- **ğŸ›¡ï¸ Type-safe**: Comprehensive field type handling with JSONB support
- **âš¡ Environment-aware**: Separate dev, test, and production configurations

## ğŸ“ Canonical Inputs (important)

- Only canonical EDN files are ingested by the migration generator:
  - `resources/db/models.edn` (generated by merging `template/shared/domain`)
  - `resources/db/{template,shared,domain}/*/policies.edn`
  - `resources/db/{template,shared,domain}/*/functions.edn`
  - `resources/db/{template,shared,domain}/*/triggers.edn`
  - `resources/db/{template,shared,domain}/*/views.edn`
- Any other EDN files (e.g., `missing_policies.edn`, `rls_enablement.edn`) are ignored by the vendor tool. Merge their contents into the canonical `policies.edn` files.

**Extended EDN shape (functions/triggers/policies/views)**:

- Files are single maps: `{:name {:up "FORWARD SQL" :down "BACKWARD SQL"}}`
- Example for the shared `updated_at` function and a `users` trigger:

  ```clojure
  ;; resources/db/shared/functions.edn
  {:update-updated-at-column
   {:up "CREATE OR REPLACE FUNCTION update_updated_at_column() ..."
    :down "DROP FUNCTION IF EXISTS update_updated_at_column();"}}

  ;; resources/db/template/triggers.edn
  {:users-updated-at-trigger
   {:up "CREATE TRIGGER users_updated_at
         BEFORE UPDATE ON users
         FOR EACH ROW
         EXECUTE FUNCTION update_updated_at_column();"
    :down "DROP TRIGGER IF EXISTS users_updated_at ON users;"}}
  ```

## ğŸ§ª REPL Utilities (preferred path)

Run migrations through `src/app/migrations/simple_repl.clj` instead of the old deps aliases:

```clojure
(require '[app.migrations.simple-repl :as mig])

(mig/make-all-migrations!)            ;; merge models â†’ schema â†’ extended
(mig/migrate!)                       ;; apply pending migrations (default :dev)
(mig/status)                         ;; list applied/pending
(mig/regenerate-extended-migrations-clean!) ;; prune extended and regenerate
(mig/check-duplicate-migrations)     ;; find duplicate numbers
(mig/sync-db-to-edn!)                ;; optional DBâ†’EDN capture
```

## ğŸ“ Support

- **Issues**: Check [Troubleshooting Guide](./troubleshooting.md)
- **Commands**: See [Command Reference](./command-reference.md)
- **Architecture**: Review [Migration Overview](./migration-overview.md)

---

*Last updated: January 2025*
