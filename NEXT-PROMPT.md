# NEXT SESSION PROMPT — 2025-12-06
PROMPT: "Plan Home Expenses Tracker implementation (app-specs/specs.md)"

## Context Snapshot
- Repo is a single-tenant SaaS template (Clojure/ClojureScript, Postgres); admin UI runs at http://localhost:8085 with simplified auth.
- Backend entry `src/app/backend/core.clj` uses Aero config + DI container in `src/app/template/di/config.clj`; admin routes live under `/admin/api` (see `app.backend.routes.admin-*`).
- Frontend shell `src/app/template/frontend/core.cljs` mounts admin app; admin routing in `src/app/admin/frontend/routes.cljs`; shared UI components/templates under `src/app/template/frontend/components` and `src/app/admin/frontend/pages`.
- DB models are source-driven: edit `resources/db/{template,shared,domain}/models.edn`; `resources/db/models.edn` is generated by migrations flow.
- Monitoring/auth baseline only: audit logs, login events, admin/users exist; no domain entities yet. Skills available: app-db-inspect, reframe-events-analysis, system-logs.
- Live dev stack auto-restarts: `bb run-app` starts backend + Shadow-CLJS watch + nREPL (port defaults 8085 / nREPL 7888).

## Task Focus
Create a concrete implementation plan for the Home Expenses Tracker domain described in `app-specs/specs.md` (receipts ingestion + expenses/payers/suppliers/articles/reports). The plan should cover backend, frontend, migrations, ADE integration, and testing steps.

## Code Map (places to inspect/extend)
- Specs source: `app-specs/specs.md` (domain requirements).
- Backend entrypoints: `src/app/backend/core.clj`, `src/app/backend/routes/admin-api.clj`, existing admin route modules in `src/app/backend/routes/admin/*` for patterns; services in `src/app/backend/services/*` and DI wiring in `src/app/template/di/config.clj`.
- Shared HTTP/utilities: `src/app/shared/*` (responses, validation, field casting, pagination, etc.).
- Frontend shell/admin patterns: `src/app/admin/frontend/core.cljs`, routes `src/app/admin/frontend/routes.cljs`, pages/components under `src/app/admin/frontend/pages` and `src/app/template/frontend/components` (list/form templates, modals, cards).
- Database models: edit `resources/db/template/models.edn` (and shared/domain as needed); migrations generated into `resources/db/migrations/` via `app.migrations.simple-repl` functions.
- Dev ops: scripts `scripts/sh/development/run-app.sh`, tasks in `bb.edn`; monitoring helper `./scripts/sh/monitoring/read_output.sh` (see system-logs skill).

## Commands to Run
- Start stack: `bb run-app` (backend + shadow watch + nREPL on 7888).
- Backend tests: `bb be-test`.
- Frontend tests: `bb fe-test` or `npm run test:cljs` (Node) / `npm run test:cljs:karma` (browser).
- Migrations workflow: in REPL `(require '[app.migrations.simple-repl :as mig])`, `(mig/make-all-migrations!)`, `(mig/migrate!)`; for dev CLI `clj -X:migrations-dev`.
- Logs: `./scripts/sh/monitoring/read_output.sh -f` (or without `-f` once) via system-logs skill.

## Gotchas
- Do NOT edit `resources/db/models.edn` directly—edit source files and regenerate migrations.
- Single-tenant: no RLS/tenant context; admin auth guard in frontend is lenient for template—tighten if needed.
- Admin API base is `/admin/api`; ensure new routes stay behind admin auth middleware.
- ADE keys/config must remain server-side; receipts must dedupe by file_hash; uploads likely to use object storage path.
- Port 8085 is in use; watchers auto-restart—avoid manual restarts.
- Remember available MCP skills (app-db-inspect, reframe-events-analysis, system-logs) for debugging instead of ad-hoc logging where possible.

## Checklist for the Next Agent (plan first)
1) Re-read docs: `docs/index.md`, `docs/backend/single-tenant-template.md`, `docs/backend/http-api.md`, `docs/backend/services.md`, `docs/frontend/admin-panel-single-tenant.md`, `docs/migrations/migration-overview.md`, `docs/operations/dev-environment.md`, plus `app-specs/specs.md` for requirements.
2) Define domain data model from spec → propose tables/fields in `resources/db/template/models.edn` (receipts, expenses, items, payers, suppliers, articles, aliases, price observations), note required enums/indexes, and outline migration generation steps.
3) Map API surface: admin/protected endpoints for receipts, expenses, payers, suppliers, articles, aliases, reports; decide upload flow (multipart), status transitions, dedupe, approve/post actions.
4) Plan services & routes wiring: new backend service namespaces + route modules, DI registration, validation, audit/login event hooks, idempotency for posting receipts.
5) Frontend plan: pages/screens (inbox, review receipt, manual expense form, reports, articles/unmapped queue), state management/events/subs, reuse list/form templates, file upload handling, polling/SSE strategy.
6) ADE integration plan: background processing steps, retry/backoff, storage of raw parse/extract JSON, review UI data shape, security for API key.
7) Testing plan: unit/service tests (`bb be-test`), frontend events/subs tests (`npm run test:cljs`), migration verification, maybe fixture data for receipts/expenses.
8) Risks/assumptions: single user/household scope, weekly starts Monday, totals vs line items, fallback for missing quantities, duplication rules.

## Create the implementation plan based on the above structure and save it in @app-spec/home-expenses-tracker-plan.md. Use this file to guide the implementation in subsequent steps and track progress.
